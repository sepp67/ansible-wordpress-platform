---
- name: Create directory for Caddy
  file:
    path: /opt/caddy
    state: directory
    mode: "0755"

- name: Ensure shared docker network 'web' exists
  command: docker network inspect web
  register: webnet
  failed_when: false
  changed_when: false

- name: Create shared docker network 'web' if missing
  command: docker network create web
  when: webnet.rc != 0

- name: Render Caddyfile
  template:
    src: Caddyfile.j2
    dest: /opt/caddy/Caddyfile
    mode: "0644"
  notify: Reload Caddy

- name: Create docker-compose.yml for Caddy
  copy:
    dest: /opt/caddy/docker-compose.yml
    mode: "0644"
    content: |
      services:
        caddy:
          image: caddy:2
          container_name: caddy
          restart: unless-stopped
          ports:
            - "80:80"
            - "443:443"
          networks:
            - web
          volumes:
            - ./Caddyfile:/etc/caddy/Caddyfile:ro
            - caddy_data:/data
            - caddy_config:/config

      volumes:
        caddy_data:
        caddy_config:

      networks:
        web:
          external: true

- name: Start/Update Caddy container
  command: docker compose up -d
  args:
    chdir: /opt/caddy

- name: Stop and remove Caddy
  command: docker compose down -v
  args:
    chdir: /opt/caddy
  ignore_errors: true
  when: destroy | default(false)
